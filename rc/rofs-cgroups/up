#!/bin/execlineb -P

fdmove -c 2 1
importas -i S6CONF S6CONF
s6-envdir ${S6CONF}
importas -D "" CGROUPS CGROUPS
ifelse -X { s6-test $CGROUPS = yes }
        {
                foreground {
                        if { s6-echo -- [ >>>> ] rofs-cgroups started }
                        if { mkdir -p -m 0755 /sys/fs/cgroup }
                        if { s6-mount -wt tmpfs cgroup /sys/fs/cgroup }
                        redirfd -r 0 /proc/cgroups
                        pipeline { s6-tail -n +2 }
                        pipeline { s6-cut -d"\t" -f1 }
                        pipeline { s6-grep -vF -- devices }
                        forstdin -d"\n" -- i
                        importas -iu i i
                        if { s6-mkdir /sys/fs/cgroup/${i} }
                        foreground { s6-mount -t cgroup -o ${i} -- cgroup /sys/fs/cgroup/${i} }
                }
                s6-echo -- [ DONE ] rofs-cgroups successfully started
        }
s6-echo -- [ WW ] rofs-cgroups desactived
