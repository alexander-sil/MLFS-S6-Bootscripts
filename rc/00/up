#!/bin/execlineb -P

fdmove -c 2 1
if { s6-echo -- [ >>>>] 00 started }

foreground {
	if { s6-echo -- [ >>>> ] Mounting virtual filesystems ... }
	# mount proc sys dev run if doesn't exist
	foreground {
		forx -p first { proc sys dev run }
		importas -ui -D "" first first
		foreground {
			if -n { mountpoint -q /$first }
			s6-envdir /etc/s6-linux-init/fs-env/$first
			importas -ui fstype fstype
                        importas -ui device device
                        importas -ui mountpoint mountpoint
                        importas -ui options options
                        s6-mount -o $options -t $fstype $device $mountpoint
                        if { s6-echo -- [ ok ] $device }
		}
	}

	# finally mount /dev/shm /dev/pts
	if {
		forx -p third { shm pts }
		importas -ui third third
			if {
				foreground {
					if -n { mountpoint -q /dev/$third }
                                        if { s6-mkdir -p -m 0755 /dev/$third }
                                        s6-envdir /etc/s6-linux-init/fs-env/$third
                                        importas -ui fstype fstype
                                        importas -ui device device
                                        importas -ui mountpoint mountpoint
                                        importas -ui options options
                                        s6-mount -o $options -n -t $fstype $device $mountpoint
                                        if { s6-echo -- [ ok ] $device }}
				}			
			}	
	}
	s6-echo -- [ DONE ] Filesystems were mounted successfully

}
# parse s6.conf before loading environment
foreground {
        
        if { s6-echo -- [ >>>> ] Parsing s6-conf }

        importas -i S6CONF S6CONF
        foreground {
                redirfd -r 0 /etc/s6-linux-init/s6.conf
                pipeline { s6-grep -vF -- "#" }
                forstdin -nCd"\n" -- conf
                importas -ui conf conf
                multidefine -d"=" $conf { var value }
                foreground {
                        if { mkdir -p ${S6CONF}/ }
                        redirfd -w 1 ${S6CONF}/$var
                        s6-echo -- $value
                }
        }
        s6-echo -- [ DONE ] s6-conf was parsed successfully
}
# load hostname for earlier tty
foreground {

        if { s6-echo -- Setting hostname }
        importas -i S6CONF S6CONF
        s6-envdir ${S6CONF}
        importas -i HOSTNAME HOSTNAME
        s6-hostname ${HOSTNAME}
}
s6-echo -- [ DONE ] 00 successfully started
