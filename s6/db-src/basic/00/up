#!/bin/execlineb -P

# Mount Virtual Kernel Fileystems
# And set hostname

fdmove -c 2 1


# Mount proc, sys, dev
if { s6-echo -- "[       00       ] 1/3 : Mounting proc, sys, dev" }
foreground {
	forx -p first { proc sys dev }
        importas -ui -D "" first first
        foreground {
            if -n { mountpoint -q /$first }
            s6-envdir /etc/s6/env-fs/$first
            importas -ui fstype fstype
            importas -ui device device
            importas -ui mountpoint mountpoint
            importas -ui options options
            s6-mount -o $options -t $fstype $device $mountpoint
        }
}

# Create lvm user lock if needed
if {
    forx -p second { lvm user lock }
    importas -ui second second
    foreground {
      if -n { s6-test -d /run/$second }
      s6-mkdir -p -m 0755 /run/$second
    }
}

# Mount /dev/shm /dev/pts
if { s6-echo -- "[       00       ] 2/3 : Mounting shm & pts in /dev"  }
if {
	 forx -p third { shm pts }
	 importas -ui third third
	 if {
	     foreground {
	         if -n { mountpoint -q /dev/$third }
	         if { s6-mkdir -p -m 0755 /dev/$third }
	         s6-envdir /etc/s6/env-fs/$third
	         importas -ui fstype fstype
	         importas -ui device device
	         importas -ui mountpoint mountpoint
	         importas -ui options options
	         s6-mount -o $options -n -t $fstype $device $mountpoint
	     }
	 }
}

# Set hostname
s6-envdir -if /etc/s6/env
importas -i HOSTNAME HOSTNAME
if { s6-echo -- "[       00       ] 3/3 : Setting hostname "  }
s6-hostname $HOSTNAME
